name: Deploy to VPS

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # 1. Forzar la carga de NVM y PM2 para el usuario root
          export NVM_DIR="/root/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          
          # 2. AÃ±adir las rutas de binarios comunes al PATH por si acaso
          export PATH=$PATH:/usr/local/bin:/usr/bin:/bin:/root/.nvm/versions/node/$(ls /root/.nvm/versions/node 2>/dev/null | head -n 1)/bin
          
          # 3. Navegar y desplegar
          cd /root/GranCanMatch_bot
          echo "ðŸš€ Desplegando en $(pwd) como $(whoami)..."
          
          git fetch --all
          git reset --hard origin/main
          
          npm install --production
          
          pm2 restart grancanmatch-bot || pm2 start src/server.js --name grancanmatch-bot
          pm2 save
