name: Deploy to VPS

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_PASSWORD }}
        script: |
          # Cargar variables de entorno (NVM, PM2, etc.)
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
          [ -s "$HOME/.bashrc" ] && source "$HOME/.bashrc"
          
          # Debug: Ver qui√©n soy y qu√© herramientas tengo
          echo "üë§ Usuario: $(whoami)"
          echo "üìÅ Ruta actual: $(pwd)"
          echo "üîß Node versi√≥n: $(node -v)"
          echo "üîß PM2 versi√≥n: $(pm2 -v)"

          # Navegar al directorio del bot
          cd /root/GranCanMatch_bot

          # Obtener los √∫ltimos cambios (Forzando la actualizaci√≥n para evitar conflictos)
          git fetch --all
          git reset --hard origin/main
          
          # Instalar dependencias
          npm install --production
          
          # Reiniciar el proceso
          pm2 restart grancanmatch-bot || pm2 start src/server.js --name grancanmatch-bot
          pm2 save
