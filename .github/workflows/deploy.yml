name: Auto-Deploy to VPS

on:
  push:
    branches:
      - '**'        # Auto-deploy desde cualquier rama

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}

        script: |
          echo "➡️ Conectado al VPS"

          # Ruta donde está el bot
          cd /root/GranCanMatch_bot || cd /home/admin/GranCanMatch_bot

          echo "➡️ Actualizando rama: ${{ github.ref_name }}"
          git fetch origin
          git checkout ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}

          echo "➡️ Instalando dependencias"
          npm install --production

          echo "➡️ Reiniciando PM2"
          pm2 restart grancanmatch-bot || pm2 start src/server.js --name grancanmatch-bot

          pm2 save

          echo "✔️ Deploy completado para rama ${{ github.ref_name }}"

